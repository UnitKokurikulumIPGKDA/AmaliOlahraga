<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPU3411 // HP3 PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #00f2ff; --bg: #0a0c10; }
        body { background: var(--bg); color: #e2e8f0; font-family: sans-serif; overflow-x: hidden; }
        .glass-card { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 26px; width: 26px; border-radius: 50%; background: var(--accent); border: 3px solid white; cursor: pointer; box-shadow: 0 0 15px var(--accent); }
        .hidden-section { display: none; }
        @media print { .no-print { display: none !important; } .print-only { display: block !important; color: black; background: white; } .page-break { page-break-after: always; } }
        .print-only { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; color: inherit; }
        th, td { border: 1px solid #444; padding: 10px; text-align: center; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto no-print">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold text-white uppercase italic tracking-tighter">AXON <span class="text-cyan-400">// HP3 SYSTEM</span></h1>
                <div id="syncStatus" class="text-[10px] font-bold text-yellow-400 uppercase animate-pulse">Menghubung...</div>
            </div>
            <div class="flex gap-2 p-1 glass-card bg-white/5">
                <button onclick="switchRole('Penilai 1')" id="roleBtn1" class="px-6 py-2 rounded-xl text-xs font-bold transition-all bg-cyan-500 text-black">P1</button>
                <button onclick="switchRole('Penilai 2')" id="roleBtn2" class="px-6 py-2 rounded-xl text-xs font-bold transition-all text-white/50">P2</button>
                <button onclick="switchRole('Admin')" id="roleBtnAdmin" class="px-6 py-2 rounded-xl text-xs font-bold transition-all text-white/50">Dashboard</button>
            </div>
        </header>

        <div id="penilaiView" class="space-y-6">
            <select id="penilaiClassFilter" onchange="handleClass(this.value)" class="w-full bg-slate-900 border border-cyan-400/30 rounded-xl p-4 text-white font-bold outline-none focus:ring-2 ring-cyan-400/50">
                <option value="">-- Pilih Kelas --</option>
            </select>
            <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="adminView" class="hidden-section glass-card p-6">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-bold text-cyan-400 uppercase">Rumusan Prestasi</h2>
                <button onclick="preparePrintReport()" class="w-full md:w-auto bg-white/10 px-6 py-2 rounded-lg text-xs font-bold border border-white/10 hover:bg-cyan-400 hover:text-black transition-all">CETAK SEMUA PDF</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px]">
                    <thead class="text-white/40 uppercase">
                        <tr><th class="text-left">Atlet</th><th>P1</th><th>P2</th><th>AI Janaan</th><th class="text-right">Gred</th></tr>
                    </thead>
                    <tbody id="adminTableBody" class="divide-y divide-white/5 text-white/80"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="fixed inset-0 z-50 flex items-center justify-center p-0 md:p-4 bg-black/95 backdrop-blur-xl hidden">
        <div class="glass-card w-full max-w-xl p-6 md:p-8 max-h-[95vh] overflow-y-auto border-white/10 rounded-none md:rounded-[24px]">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <h2 id="modalStudentName" class="text-2xl font-bold text-white uppercase tracking-tight">Nama Pelajar</h2>
                    <button onclick="openRubrik()" class="text-[9px] bg-amber-500/20 text-amber-400 px-3 py-1 rounded-full border border-amber-500/30 mt-2 uppercase font-bold">ðŸ“– Rujukan Rubrik</button>
                </div>
                <button onclick="closeModal()" class="text-white/40 text-4xl leading-none">&times;</button>
            </div>

            <div class="space-y-10">
                <div class="space-y-4">
                    <div class="flex justify-between items-end"><span class="text-[10px] font-bold text-white/40 uppercase">1. Lari Pecut (25%)</span><span id="valPecut" class="text-4xl font-bold text-cyan-400 tabular-nums">0.0</span></div>
                    <div id="stagePecut" class="mb-4 h-5"></div>
                    <input type="range" id="sliderPecut" min="0" max="25" step="0.1" value="0" oninput="updateUI()" class="w-full">
                    <div id="detPecut" class="mt-4 space-y-2"></div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-end"><span class="text-[10px] font-bold text-white/40 uppercase">2. Lontar Peluru (25%)</span><span id="valLontar" class="text-4xl font-bold text-purple-400 tabular-nums">0.0</span></div>
                    <div id="stageLontar" class="mb-4 h-5"></div>
                    <input type="range" id="sliderLontar" min="0" max="25" step="0.1" value="0" oninput="updateUI()" class="w-full">
                    <div id="detLontar" class="mt-4 space-y-2"></div>
                </div>

                <button id="btnSave" onclick="saveData()" class="w-full py-5 rounded-2xl bg-cyan-500 text-black font-bold uppercase text-xs tracking-widest shadow-xl shadow-cyan-500/20 active:scale-95 transition-all">Hantar Markah Live</button>
            </div>
        </div>
    </div>

    <div id="rubrikModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/95 hidden">
        <div class="glass-card w-full max-w-sm p-6 border-white/10">
            <h3 class="text-white font-bold mb-4 uppercase text-center">Pemberatan Aras</h3>
            <div class="space-y-3 text-[11px] uppercase font-bold">
                <div class="flex justify-between text-emerald-400 p-2 bg-white/5 rounded"><span>Aras Mudah</span><span>12 Markah</span></div>
                <div class="flex justify-between text-amber-400 p-2 bg-white/5 rounded"><span>Aras Sederhana</span><span>8 Markah</span></div>
                <div class="flex justify-between text-red-400 p-2 bg-white/5 rounded"><span>Aras Sukar</span><span>5 Markah</span></div>
            </div>
            <button onclick="closeRubrik()" class="w-full mt-6 py-3 bg-white/10 rounded-xl text-xs font-bold">Tutup</button>
        </div>
    </div>

    <div id="printReport" class="print-only"></div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzVzaPdACxnvKJDRG5cqKDZBhLu6V8z3g3N4MT55scDGIAgU-r3ekjMAt_Zj4x8O75lBg/exec";
        const groqApiKey = "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";

        let students = [], liveMarks = {}, selectedClass = "", currentRole = "Penilai 1", activeId = null;

        const skemaPecut = [{n:"Penamat (MUDAH)", l:12, c:"text-emerald-400"}, {n:"Permulaan (SEDERHANA)", l:8, c:"text-amber-400"}, {n:"Teknik Larian (SUKAR)", l:5, c:"text-red-400"}];
        const skemaLontar = [{n:"Sedia (MUDAH)", l:12, c:"text-emerald-400"}, {n:"Lungsur (SEDERHANA)", l:8, c:"text-amber-400"}, {n:"Lontar (SUKAR)", l:5, c:"text-red-400"}];

        async function fetchMarks() {
            try {
                const res = await fetch(scriptURL);
                const data = await res.json();
                students = data.students; liveMarks = data.marks;
                document.getElementById('syncStatus').innerText = "DATA LIVE DISINKRON";
                initFilter(); renderView();
            } catch (e) { document.getElementById('syncStatus').innerText = "RALAT HUBUNGAN"; }
        }

        function initFilter() {
            const classes = [...new Set(students.map(s => s.class))].sort();
            const filter = document.getElementById('penilaiClassFilter');
            filter.innerHTML = '<option value="">-- Pilih Kelas --</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        window.handleClass = (v) => { selectedClass = v; renderView(); }

        window.updateUI = () => {
            const p = parseFloat(document.getElementById('sliderPecut').value);
            const l = parseFloat(document.getElementById('sliderLontar').value);
            document.getElementById('valPecut').innerText = p.toFixed(1);
            document.getElementById('valLontar').innerText = l.toFixed(1);

            const catP = getCategory(p);
            document.getElementById('stagePecut').innerHTML = `<span class="px-3 py-1 rounded-full text-[9px] font-bold" style="background:${catP.color}22; color:${catP.color}">${catP.label}</span>`;
            const catL = getCategory(l);
            document.getElementById('stageLontar').innerHTML = `<span class="px-3 py-1 rounded-full text-[9px] font-bold" style="background:${catL.color}22; color:${catL.color}">${catL.label}</span>`;

            renderWaterfill('detPecut', p, skemaPecut, 'bg-cyan-400');
            renderWaterfill('detLontar', l, skemaLontar, 'bg-purple-400');
        }

        function renderWaterfill(id, total, skema, color) {
            let rem = total;
            document.getElementById(id).innerHTML = skema.map(item => {
                const s = Math.min(rem, item.l); rem -= s;
                return `<div class="mt-2 text-[8px] uppercase font-bold text-white/20">
                    <div class="flex justify-between"><span class="${item.c}">${item.n}</span><span>${s.toFixed(1)} / ${item.l}</span></div>
                    <div class="h-1 bg-white/5 rounded-full overflow-hidden mt-1"><div class="${color} h-full" style="width:${(s/item.l)*100}%"></div></div></div>`;
            }).join('');
        }

        function getCategory(v) {
            if (v >= 23) return { label: 'Amat Cemerlang', color: '#10b981' };
            if (v >= 19) return { label: 'Cemerlang', color: '#3b82f6' };
            if (v >= 15) return { label: 'Kepujian', color: '#f59e0b' };
            if (v >= 13) return { label: 'Sederhana', color: '#f97316' };
            return { label: 'Lemah', color: '#ef4444' };
        }

        // FUNGSI JANA AI DENGAN FALLBACK
        window.generateFinalAI = async (id) => {
            const btn = document.querySelector(`button[data-id="${id}"]`);
            btn.innerText = "Menjana..."; btn.disabled = true;

            const s = students.find(x => x.id === id);
            const m = liveMarks[id] || {};
            const p1 = m['Penilai 1'] || {pecut:0, lontar:0};
            const p2 = m['Penilai 2'] || {pecut:0, lontar:0};
            const avgP = ((parseFloat(p1.pecut) + parseFloat(p2.pecut)) / 2).toFixed(2);
            const avgL = ((parseFloat(p1.lontar) + parseFloat(p2.lontar)) / 2).toFixed(2);

            let aiResult = `Atlet menunjukkan penguasaan teknik yang baik dengan purata larian ${avgP} dan lontaran ${avgL}. Perlu konsisten dalam fasa sukar.`;

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${groqApiKey}` },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [{role: "user", content: `Ulasan sukan Bahasa Melayu 15 kata untuk ${s.name}: Purata Larian ${avgP}/25, Lontaran ${avgL}/25.`}]
                    })
                });
                const data = await response.json();
                if(data.choices) aiResult = data.choices[0].message.content;
            } catch (e) { console.warn("API Gagal, menggunakan fallback ulasan."); }

            await fetch(scriptURL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ id: id, finalPecut: avgP, finalLontar: avgL, aiReport: aiResult }) 
            });
            
            fetchMarks();
        }

        window.preparePrintReport = () => {
            const container = document.getElementById('printReport');
            const filtered = students.filter(s => !selectedClass || s.class === selectedClass);
            container.innerHTML = filtered.map(s => {
                const m = liveMarks[s.id] || {};
                const p1 = m['Penilai 1'] || {pecut:0, lontar:0};
                const p2 = m['Penilai 2'] || {pecut:0, lontar:0};
                const avgP = ((parseFloat(p1.pecut) + parseFloat(p2.pecut)) / 2).toFixed(2);
                const avgL = ((parseFloat(p1.lontar) + parseFloat(p2.lontar)) / 2).toFixed(2);
                return `
                <div class="page-break" style="padding:40px; font-family:sans-serif; background:white; color:black; border:2px solid #000; margin-bottom:20px;">
                    <h2 style="text-align:center; border-bottom:2px solid #000; padding-bottom:10px;">LAPORAN PENTAKSIRAN HP3</h2>
                    <p><b>ATLET:</b> ${s.name} | <b>KELAS:</b> ${s.class}</p>
                    <table style="width:100%; border:1px solid #000; border-collapse:collapse;">
                        <tr style="background:#eee"><th>ACARA</th><th>PENILAI 1</th><th>PENILAI 2</th><th>PURATA AKHIR</th></tr>
                        <tr><td>LARI PECUT</td><td>${p1.pecut}</td><td>${p2.pecut}</td><td><b>${avgP}</b></td></tr>
                        <tr><td>LONTAR PELURU</td><td>${p1.lontar}</td><td>${p2.lontar}</td><td><b>${avgL}</b></td></tr>
                    </table>
                    <div style="margin-top:20px; padding:15px; border-left:5px solid #00f2ff; background:#f9f9f9">
                        <b>ANALISIS PRESTASI (AI):</b><br>
                        <p>${m.aiReport || "Belum dijana. Klik butang Jana AI di Dashboard."}</p>
                    </div>
                </div>`;
            }).join('');
            window.print();
        }

        window.saveData = async () => {
            const p = parseFloat(document.getElementById('sliderPecut').value);
            const l = parseFloat(document.getElementById('sliderLontar').value);
            const btn = document.getElementById('btnSave'); btn.disabled = true; btn.innerText = "Menghantar...";
            try {
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ id: activeId, role: currentRole, pecut: p, lontar: l }) });
                closeModal(); fetchMarks();
            } finally { btn.disabled = false; btn.innerText = "Hantar Markah Live"; }
        }

        window.switchRole = (r) => {
            currentRole = r;
            ['roleBtn1', 'roleBtn2', 'roleBtnAdmin'].forEach(id => document.getElementById(id).className = "px-6 py-2 rounded-xl text-xs font-bold transition-all text-white/50 hover:text-white");
            const activeBtn = r === 'Penilai 1' ? 'roleBtn1' : r === 'Penilai 2' ? 'roleBtn2' : 'roleBtnAdmin';
            document.getElementById(activeBtn).className = "px-6 py-2 rounded-xl text-xs font-bold transition-all bg-cyan-500 text-black";
            document.getElementById('penilaiView').classList.toggle('hidden-section', r === 'Admin');
            document.getElementById('adminView').classList.toggle('hidden-section', r !== 'Admin');
            renderView();
        }

        function renderView() { if(currentRole === 'Admin') renderAdminTable(); else renderStudentList(); }

        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            const filtered = students.filter(s => !selectedClass || s.class === selectedClass);
            tbody.innerHTML = filtered.map(s => {
                const m = liveMarks[s.id] || {};
                const p1 = m['Penilai 1'] || {pecut:0, lontar:0};
                const p2 = m['Penilai 2'] || {pecut:0, lontar:0};
                const p1Avg = (parseFloat(p1.pecut) + parseFloat(p1.lontar))/2;
                const p2Avg = (parseFloat(p2.pecut) + parseFloat(p2.lontar))/2;
                const final = (p1Avg + p2Avg)/2;
                return `<tr>
                    <td class="p-4 font-bold text-white uppercase">${s.name}</td>
                    <td class="p-4 text-center mono">${p1Avg.toFixed(1)}</td>
                    <td class="p-4 text-center mono">${p2Avg.toFixed(1)}</td>
                    <td class="p-4 text-center"><button data-id="${s.id}" onclick="generateFinalAI('${s.id}')" class="bg-cyan-500/10 text-cyan-400 px-3 py-1 rounded-lg border border-cyan-400/20 text-[9px] font-bold">âœ¨ JANA AI</button></td>
                    <td class="p-4 text-right font-bold uppercase" style="color:${getCategory(final*2).color}">${getCategory(final*2).label}</td>
                </tr>`;
            }).join('');
        }

        function renderStudentList() {
            const container = document.getElementById('studentList');
            if (!selectedClass) { container.innerHTML = '<div class="col-span-full text-center text-white/20 p-10 uppercase text-xs tracking-widest font-bold">Sila Pilih Kelas Terlebih Dahulu</div>'; return; }
            const filtered = students.filter(s => s.class === selectedClass);
            container.innerHTML = filtered.map(s => {
                const hasMark = liveMarks[s.id] && liveMarks[s.id][currentRole] && (liveMarks[s.id][currentRole].pecut > 0 || liveMarks[s.id][currentRole].lontar > 0);
                return `<div onclick="openScoring('${s.id}')" class="glass-card p-5 cursor-pointer hover:border-cyan-400/50 flex justify-between items-center transition-all active:scale-95 group">
                    <div><h3 class="font-bold text-sm text-white group-hover:text-cyan-400 transition-colors uppercase italic">${s.name}</h3></div>
                    <div class="h-2 w-2 rounded-full ${hasMark ? 'bg-emerald-500 shadow-[0_0_10px_#10b981]' : 'bg-orange-500 shadow-[0_0_10px_#f59e0b]'}"></div>
                </div>`;
            }).join('');
        }

        window.openScoring = (id) => { activeId = id; const s = students.find(x => x.id === id); document.getElementById('modalStudentName').innerText = s.name; const m = (liveMarks[id] && liveMarks[id][currentRole]) || { pecut: 0, lontar: 0 }; document.getElementById('sliderPecut').value = m.pecut; document.getElementById('sliderLontar').value = m.lontar; updateUI(); document.getElementById('scoringModal').classList.remove('hidden'); }
        window.openRubrik = () => document.getElementById('rubrikModal').classList.remove('hidden');
        window.closeRubrik = () => document.getElementById('rubrikModal').classList.add('hidden');
        window.closeModal = () => document.getElementById('scoringModal').classList.add('hidden');
        window.onload = fetchMarks;
    </script>
</body>
</html>
