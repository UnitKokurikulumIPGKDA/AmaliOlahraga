<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXON // HP3 AI TACTICAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00f2ff; --bg: #05070a; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'JetBrains Mono', monospace; }
        h1, h2, h3, .impact { font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }
        .glass-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--accent); border: 3px solid white; cursor: pointer; box-shadow: 0 0 15px var(--accent); }
        .hidden-section { display: none; }

        @media print {
            @page { size: A4; margin: 0; }
            .no-print { display: none !important; }
            .print-only { display: block !important; color: black; background: white; width: 210mm; }
            body { background: white !important; margin: 0; padding: 0; }
            .report-page { width: 210mm; height: 297mm; padding: 10mm; box-sizing: border-box; page-break-after: always; display: flex; flex-direction: column; justify-content: space-between; }
            .student-row-pdf { height: 135mm; border: 2px solid #000; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; }
            table { width: 100%; border-collapse: collapse; border: 1.5px solid black; font-size: 13px; margin: 10px 0; }
            th, td { border: 1.5px solid black; padding: 6px; text-align: center; color: black !important; }
            .student-img-pdf { width: 80px; height: 100px; object-fit: cover; border: 1px solid #000; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto no-print">
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6 text-center border-b border-white/10 pb-6">
            <h1 class="text-6xl text-white italic impact">AMALI MPU3411 <span class="text-cyan-400">// HP3</span></h1>
            <div class="flex gap-2 p-1 glass-card bg-white/5 font-bold">
                <button onclick="switchRole('Penilai 1')" id="roleBtn1" class="px-6 py-2 rounded-xl text-xs bg-cyan-500 text-black font-bold">P1</button>
                <button onclick="switchRole('Penilai 2')" id="roleBtn2" class="px-6 py-2 rounded-xl text-xs text-white/50">P2</button>
                <button onclick="switchRole('Admin')" id="roleBtnAdmin" class="px-6 py-2 rounded-xl text-xs text-white/50">RUMUSAN</button>
            </div>
        </header>

        <div id="penilaiView" class="space-y-6">
            <select id="penilaiClassFilter" onchange="handleClass(this.value)" class="w-full bg-black border border-white/10 rounded-xl p-4 text-cyan-400 font-bold outline-none italic uppercase">
                <option value="">-- PILIH KELAS SEKTOR --</option>
            </select>
            <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="adminView" class="hidden-section glass-card p-6 text-white">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl impact text-cyan-400 uppercase">Dashboard Rumusan</h2>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <select id="adminClassFilter" onchange="renderAdminTable()" class="bg-black border border-white/10 rounded-lg px-4 py-2 text-xs font-bold text-white outline-none">
                        <option value="">-- SEMUA KELAS --</option>
                    </select>
                    <button id="btnPrintPDF" onclick="preparePrintReport()" class="bg-white text-black px-6 py-2 rounded-lg text-xs font-bold hover:bg-cyan-400 transition-all uppercase italic">Cetak PDF (2/Page)</button>
                </div>
            </div>
            <table class="w-full text-left text-[10px] text-white">
                <thead class="border-b border-white/10 text-white/40 uppercase font-bold italic">
                    <tr>
                        <th class="p-4">Nama Pelajar</th>
                        <th class="p-4 text-center">Avg Larian</th>
                        <th class="p-4 text-center">Avg Lontaran</th>
                        <th class="p-4 text-center">AI Analysis</th>
                        <th class="p-4 text-right">Tahap</th>
                    </tr>
                </thead>
                <tbody id="adminTableBody" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
    </div>

    <div id="scoringModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl hidden">
        <div class="glass-card w-full max-w-4xl p-6 md:p-8 max-h-[95vh] overflow-y-auto relative border-cyan-400/30">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-4 flex flex-col items-center border-r border-white/10 pr-6">
                    <img id="modalStudentImg" src="" class="w-full aspect-[3/4] bg-white/5 border border-white/10 rounded-lg object-cover mb-4">
                    <div id="liveGradeDisplay" class="text-xl font-bold impact italic text-cyan-400 uppercase">TAHAP: -</div>
                </div>
                <div class="md:col-span-8">
                    <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-4">
                        <h2 id="modalStudentName" class="text-4xl impact text-white italic">PELAJAR</h2>
                        <button onclick="closeModal()" class="text-cyan-500 text-4xl">×</button>
                    </div>
                    <div class="space-y-12">
                        <div class="space-y-4">
                            <div class="flex justify-between impact text-xl text-cyan-400 italic"><span>01_Lari_Pecut [Algo_Input]</span><span id="txtPFull" class="text-4xl text-white">0.0</span></div>
                            <input type="range" id="slPFull" min="0" max="25" step="0.1" value="0" oninput="updateUI()">
                            <div id="detPecut" class="grid grid-cols-3 gap-2 mt-2"></div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between impact text-xl text-purple-400 italic"><span>02_Lontar_Peluru [Algo_Input]</span><span id="txtLFull" class="text-4xl text-white">0.0</span></div>
                            <input type="range" id="slLFull" min="0" max="25" step="0.1" value="0" oninput="updateUI()">
                            <div id="detLontar" class="grid grid-cols-4 gap-2 mt-2"></div>
                        </div>
                        <button id="btnSave" onclick="saveData()" class="impact w-full py-5 rounded-2xl bg-cyan-500 text-black text-xl hover:bg-white active:scale-95 transition-all uppercase italic">Simpan Markah Live</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="printReport" class="print-only"></div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzVzaPdACxnvKJDRG5cqKDZBhLu6V8z3g3N4MT55scDGIAgU-r3ekjMAt_Zj4x8O75lBg/exec";
        let students = [], liveMarks = {}, selectedClass = "", currentRole = "Penilai 1", activeId = null;

        const fasaPecut = [{n:"Persediaan", weight:12/25, max:12, color:"text-emerald-400"}, {n:"Sedia/Mula", weight:8/25, max:8, color:"text-amber-400"}, {n:"Penamat", weight:5/25, max:5, color:"text-red-400"}];
        const fasaLontar = [{n:"Sedia", weight:12/25, max:12, color:"text-emerald-400"}, {n:"Lungsur", weight:8/25, max:8, color:"text-amber-400"}, {n:"Lontar", weight:3/25, max:3, color:"text-blue-400"}, {n:"Pulihan", weight:2/25, max:2, color:"text-red-400"}];

        async function fetchMarks() {
            try {
                const res = await fetch(scriptURL);
                const data = await res.json();
                students = data.students || []; 
                liveMarks = data.marks || {};
                initFilters(); renderView();
            } catch (e) { alert("RALAT SAMBUNGAN!"); }
        }

        function initFilters() {
            const classes = [...new Set(students.map(s => s.class))].filter(c => c).sort();
            const pF = document.getElementById('penilaiClassFilter'), aF = document.getElementById('adminClassFilter');
            pF.innerHTML = '<option value="">-- PILIH KELAS SEKTOR --</option>';
            aF.innerHTML = '<option value="">-- SEMUA KELAS --</option>';
            classes.forEach(c => { pF.innerHTML += `<option value="${c}">${c}</option>`; aF.innerHTML += `<option value="${c}">${c}</option>`; });
        }

        window.handleClass = (v) => { selectedClass = v; renderStudentList(); }

        window.updateUI = () => {
            const pVal = parseFloat(document.getElementById('slPFull').value) || 0, lVal = parseFloat(document.getElementById('slLFull').value) || 0;
            document.getElementById('txtPFull').innerText = pVal.toFixed(1);
            document.getElementById('txtLFull').innerText = lVal.toFixed(1);
            const renderAlgo = (id, val, fasa) => { document.getElementById(id).innerHTML = fasa.map(f => { const mark = (val * f.weight).toFixed(1); return `<div class="bg-white/5 p-2 rounded text-center border border-white/5"><div class="text-[7px] text-white/40 uppercase font-bold tracking-tighter">${f.n}</div><div class="text-[10px] font-bold ${f.color}">${mark}/${f.max}</div></div>`; }).join(''); };
            renderAlgo('detPecut', pVal, fasaPecut); renderAlgo('detLontar', lVal, fasaLontar);
            const cat = getCategory(pVal); document.getElementById('liveGradeDisplay').innerText = `TAHAP: ${cat.label}`; document.getElementById('liveGradeDisplay').style.color = cat.color;
        }

        function getCategory(v) { if (v >= 23) return { label: 'AMAT CEMERLANG', color: '#10b981' }; if (v >= 19) return { label: 'CEMERLANG', color: '#3b82f6' }; if (v >= 15) return { label: 'KEPUJIAN', color: '#a855f7' }; if (v >= 13) return { label: 'SEDERHANA', color: '#f97316' }; return { label: 'LEMAH', color: '#ef4444' }; }

        window.renderStudentList = () => { const container = document.getElementById('studentList'); if (!selectedClass) { container.innerHTML = '<div class="col-span-full text-center p-20 italic">Sila Pilih Kelas</div>'; return; } const filtered = students.filter(s => s.class === selectedClass); container.innerHTML = filtered.map(s => { const hasMark = liveMarks[s.id] && liveMarks[s.id][currentRole] && (liveMarks[s.id][currentRole].pecut > 0); return `<div onclick="openScoring('${s.id}')" class="glass-card p-6 cursor-pointer hover:border-cyan-400 transition-all flex justify-between items-center group"><span class="font-bold text-sm text-white uppercase italic">${s.name}</span><div class="h-2 w-2 rounded-full ${hasMark ? 'bg-cyan-400 shadow-[0_0_10px_#00f2ff]' : 'bg-red-900'}"></div></div>`; }).join(''); }

        window.renderAdminTable = () => { 
            const tbody = document.getElementById('adminTableBody'), filter = document.getElementById('adminClassFilter').value; 
            const filtered = students.filter(s => !filter || s.class === filter); 
            tbody.innerHTML = filtered.map(s => { 
                const m = liveMarks[s.id] || {}; 
                const avgLarian = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0))/2).toFixed(1);
                const avgLontaran = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0))/2).toFixed(1);
                const cat = getCategory(parseFloat(avgLarian)); 
                return `<tr>
                    <td class="p-4 font-bold text-white uppercase italic">${s.name}</td>
                    <td class="p-4 text-center text-cyan-400">${avgLarian}</td>
                    <td class="p-4 text-center text-purple-400">${avgLontaran}</td>
                    <td class="p-4 text-center">
                        <button data-id="${s.id}" onclick="generateAI('${s.id}')" class="bg-cyan-500/10 text-cyan-400 px-3 py-1 border border-cyan-400/20 text-[9px] font-bold italic uppercase hover:bg-cyan-400 hover:text-black transition-all">✨ JANA_AI</button>
                    </td>
                    <td class="p-4 text-right font-bold italic" style="color:${cat.color}">${cat.label}</td>
                </tr>`; 
            }).join(''); 
        }

        // --- FUNGSI JANA AI DIPERBAIKI ---
        window.generateAI = async (id) => {
            const s = students.find(x => x.id === id);
            const m = liveMarks[id] || {};
            const avgLarian = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0))/2).toFixed(1);
            const avgLontaran = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0))/2).toFixed(1);
            
            const btn = document.querySelector(`button[data-id="${id}"]`);
            btn.innerText = "LINKING..."; btn.disabled = true;

            try {
                await fetch(scriptURL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        type: "JANA_AI", 
                        id: id, 
                        nama: s.name, 
                        finalPecut: avgLarian, 
                        finalLontar: avgLontaran 
                    }) 
                });
                fetchMarks();
            } catch (e) { btn.disabled = false; btn.innerText = "RETRY"; }
        }

        window.preparePrintReport = async () => {
            const btn = document.getElementById('btnPrintPDF'); btn.innerText = "SILA TUNGGU..."; btn.disabled = true;
            const container = document.getElementById('printReport'), filter = document.getElementById('adminClassFilter').value;
            const filtered = students.filter(s => !filter || s.class === filter);
            let html = "";
            for (let i = 0; i < filtered.length; i += 2) {
                html += `<div class="report-page">`;
                for (let j = i; j < i + 2 && j < filtered.length; j++) {
                    const s = filtered[j], m = liveMarks[s.id] || {}, ap = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0)) / 2).toFixed(2), al = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0)) / 2).toFixed(2);
                    html += `<div class="student-row-pdf">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div><h3 style="margin:0; font-size:22px; text-decoration:underline;">LAPORAN PENTAKSIRAN HP3</h3><p style="margin:5px 0; font-size:14px; font-family:sans-serif;"><b>NAMA PELAJAR:</b> ${s.name}<br><b>KELAS:</b> ${s.class} | <b>ID:</b> ${s.id}</p></div>
                            <img src="${s.image}" class="student-img-pdf" onerror="this.src='https://via.placeholder.com/80x100?text=ERR'">
                        </div>
                        <table><tr style="background:#eee"><th>ACARA OLAHRAGA</th><th>PENILAI 1</th><th>PENILAI 2</th><th>PURATA AKHIR</th></tr>
                        <tr><td>LARI PECUT (25%)</td><td>${m['Penilai 1']?.pecut||0}</td><td>${m['Penilai 2']?.pecut||0}</td><td><b>${ap}</b></td></tr>
                        <tr><td>LONTAR PELURU (25%)</td><td>${m['Penilai 1']?.lontar||0}</td><td>${m['Penilai 2']?.lontar||0}</td><td><b>${al}</b></td></tr></table>
                        <div style="padding:15px; border-left:6px solid #00f2ff; background:#f9f9f9; font-size:12px; color:black;"><b>RUMUSAN PRESTASI (AI Analysis):</b><br><i>${m.aiReport || "Belum dijana."}</i></div>
                    </div>`;
                }
                html += `</div>`;
            }
            container.innerHTML = html;
            const images = Array.from(container.querySelectorAll('img'));
            await Promise.all(images.map(img => { if (img.complete) return Promise.resolve(); return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; }); }));
            setTimeout(() => { window.print(); btn.innerText = "Cetak PDF (2/Page)"; btn.disabled = false; }, 1000);
        }

        window.openScoring = (id) => { activeId = id; const s = students.find(x => x.id === id); if(!s) return; document.getElementById('modalStudentName').innerText = s.name; document.getElementById('modalStudentImg').src = s.image || ''; const m = (liveMarks[id] && liveMarks[id][currentRole]) || { pecut: 0, lontar: 0 }; document.getElementById('slPFull').value = m.pecut; document.getElementById('slLFull').value = m.lontar; updateUI(); document.getElementById('scoringModal').classList.remove('hidden'); }
        window.saveData = async () => { const p = parseFloat(document.getElementById('slPFull').value), l = parseFloat(document.getElementById('slLFull').value); const btn = document.getElementById('btnSave'); btn.innerText = "SAVING..."; btn.disabled = true; try { await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "SAVE_MARKS", id: activeId, role: currentRole, pecut: p, lontar: l }) }); closeModal(); fetchMarks(); } finally { btn.innerText = "Simpan Markah Live"; btn.disabled = false; } }
        window.closeModal = () => document.getElementById('scoringModal').classList.add('hidden');
        window.switchRole = (r) => { currentRole = r; ['roleBtn1', 'roleBtn2', 'roleBtnAdmin'].forEach(id => document.getElementById(id).className = "px-6 py-2 rounded-xl text-xs font-bold text-white/50 transition-all"); document.getElementById(r==='Penilai 1'?'roleBtn1':r==='Penilai 2'?'roleBtn2':'roleBtnAdmin').className = "px-6 py-2 rounded-xl text-xs bg-cyan-500 text-black font-bold transition-all"; renderView(); }
        function renderView() { const pView = document.getElementById('penilaiView'), aView = document.getElementById('adminView'); if(currentRole === 'Admin') { pView.classList.add('hidden-section'); aView.classList.remove('hidden-section'); renderAdminTable(); } else { pView.classList.remove('hidden-section'); aView.classList.add('hidden-section'); renderStudentList(); } }
        window.onload = fetchMarks;
    </script>
</body>
</html>
