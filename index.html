<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXON // HP3 TACTICAL TERMINAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00f2ff; --bg: #05070a; --panel: rgba(10, 15, 25, 0.8); }
        body { 
            background: var(--bg); color: #a0aec0; 
            font-family: 'JetBrains Mono', monospace;
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 4px, 3px 100%;
        }
        h1, h2, .impact { font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; }
        .terminal-card { 
            background: var(--panel); border-left: 4px solid var(--accent);
            box-shadow: 10px 10px 0px rgba(0, 242, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .terminal-card:hover { transform: translate(-2px, -2px); box-shadow: 15px 15px 0px rgba(0, 242, 255, 0.1); }
        input[type=range] { -webkit-appearance: none; background: rgba(0, 242, 255, 0.1); height: 4px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; background: var(--accent); border: 2px solid #fff; cursor: pointer; }
        .hidden-section { display: none; }
        
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; color: black; background: white; }
            .report-card { height: 297mm; display: flex; flex-direction: column; page-break-after: always; }
            .student-row { height: 48%; border: 2px solid #000; padding: 25px; margin-bottom: 2%; display: flex; flex-direction: column; justify-content: center; }
            .student-img { width: 90px; height: 110px; object-fit: cover; border: 1px solid #000; }
        }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-6xl mx-auto no-print">
        <header class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12 border-b border-cyan-900/30 pb-6 items-end">
            <div class="md:col-span-2">
                <h1 class="text-6xl md:text-8xl text-white italic italic leading-none">AXON <span class="text-cyan-400">// HP3</span></h1>
                <p class="text-cyan-500 font-bold text-xs mt-2 tracking-[0.5em] uppercase">Tactical Athletics Evaluation System</p>
            </div>
            <div class="flex flex-col gap-2">
                <div class="flex bg-cyan-950/20 p-1 border border-cyan-900/50">
                    <button onclick="switchRole('Penilai 1')" id="roleBtn1" class="flex-1 py-2 text-[10px] font-bold bg-cyan-500 text-black">P1</button>
                    <button onclick="switchRole('Penilai 2')" id="roleBtn2" class="flex-1 py-2 text-[10px] font-bold text-cyan-500 hover:bg-cyan-500/10">P2</button>
                    <button onclick="switchRole('Admin')" id="roleBtnAdmin" class="flex-1 py-2 text-[10px] font-bold text-cyan-500 hover:bg-cyan-500/10">DASHBOARD</button>
                </div>
                <div id="syncStatus" class="text-[9px] text-right text-cyan-700 uppercase tracking-tighter italic">SYS_STATUS: CONNECTED</div>
            </div>
        </header>

        <div id="penilaiView" class="space-y-10">
            <div class="max-w-md">
                <label class="text-[10px] uppercase font-bold text-cyan-700 mb-2 block tracking-widest">Select_Sector_Class:</label>
                <select id="penilaiClassFilter" onchange="handleClass(this.value)" class="w-full bg-black border border-cyan-900/50 p-4 text-cyan-400 font-bold outline-none appearance-none">
                    <option value="">-- NO_SELECTION --</option>
                </select>
            </div>
            <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-1 gap-y-6"></div>
        </div>

        <div id="adminView" class="hidden-section space-y-6">
            <div class="terminal-card p-6 border-cyan-400 bg-cyan-950/10 flex flex-col md:flex-row justify-between items-center gap-6">
                <h2 class="text-4xl text-white">Central_Intelligence_Dashboard</h2>
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <select id="adminClassFilter" onchange="renderAdminTable()" class="bg-black border border-cyan-900 px-4 py-2 text-[10px] text-cyan-400 outline-none">
                        <option value="">-- ALL_CLASSES --</option>
                    </select>
                    <button onclick="preparePrintReport()" class="impact bg-white text-black px-8 py-2 text-sm hover:bg-cyan-400 transition-colors">GENERATE_REPORTS</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[11px] border-none">
                    <thead class="bg-cyan-900/20 text-cyan-500 uppercase tracking-widest">
                        <tr><th class="p-4">Agent_Name</th><th class="p-4">P1_Avg</th><th class="p-4">P2_Avg</th><th class="p-4">AI_Neural_Link</th><th class="p-4 text-right">Status</th></tr>
                    </thead>
                    <tbody id="adminTableBody" class="divide-y divide-cyan-900/20"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="scoringModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md hidden">
        <div class="glass-card w-full max-w-2xl p-8 border-cyan-400/30 overflow-y-auto max-h-[95vh] relative">
            <div class="absolute top-4 right-8 text-[10px] text-cyan-800">SCORING_V.2.4</div>
            <div class="flex justify-between items-start mb-12 border-b border-cyan-900 pb-4">
                <div>
                    <h2 id="modalStudentName" class="text-5xl text-white leading-none impact italic">STUDENT_NAME</h2>
                    <div id="stageStatus" class="mt-2 text-[10px] font-bold text-cyan-400 uppercase tracking-[0.3em]"></div>
                </div>
                <button onclick="closeModal()" class="text-cyan-500 text-4xl leading-none hover:text-white transition-colors">X</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-10">
                <div class="md:col-span-3 space-y-12">
                    <div class="space-y-4">
                        <div class="flex justify-between impact text-cyan-600"><span>01_SPRINT_ANALYSIS</span><span id="valPecut" class="text-4xl text-white">0.0</span></div>
                        <input type="range" id="sliderPecut" min="0" max="25" step="0.1" value="0" oninput="updateUI()" class="w-full">
                        <div id="detPecut" class="space-y-3"></div>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between impact text-cyan-600"><span>02_SHOTPUT_ANALYSIS</span><span id="valLontar" class="text-4xl text-white">0.0</span></div>
                        <input type="range" id="sliderLontar" min="0" max="25" step="0.1" value="0" oninput="updateUI()" class="w-full">
                        <div id="detLontar" class="space-y-3"></div>
                    </div>
                </div>
                <div class="md:col-span-2 flex flex-col justify-end">
                    <button onclick="saveData()" class="impact w-full py-8 text-2xl bg-cyan-500 text-black hover:bg-white active:scale-95 transition-all">SYNC_DATA_LIVE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="printReport" class="print-only"></div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzVzaPdACxnvKJDRG5cqKDZBhLu6V8z3g3N4MT55scDGIAgU-r3ekjMAt_Zj4x8O75lBg/exec";
        let students = [], liveMarks = {}, selectedClass = "", currentRole = "Penilai 1", activeId = null;

        const skemaPecut = [{n:"END_PHASE", l:12, c:"text-emerald-500"}, {n:"START_PHASE", l:8, c:"text-amber-500"}, {n:"TECH_RUN", l:5, c:"text-rose-500"}];
        const skemaLontar = [{n:"READY_PHASE", l:12, c:"text-emerald-500"}, {n:"SLIDE_PHASE", l:8, c:"text-amber-500"}, {n:"TECH_THROW", l:5, c:"text-rose-500"}];

        async function fetchMarks() {
            try {
                const res = await fetch(scriptURL);
                const data = await res.json();
                students = data.students; liveMarks = data.marks;
                initFilters(); renderView();
            } catch (e) { document.getElementById('syncStatus').innerText = "SYS_STATUS: OFFLINE"; }
        }

        function initFilters() {
            const classes = [...new Set(students.map(s => s.class))].sort();
            const pFilter = document.getElementById('penilaiClassFilter');
            const aFilter = document.getElementById('adminClassFilter');
            const prevA = aFilter.value;
            pFilter.innerHTML = '<option value="">-- NO_SELECTION --</option>';
            aFilter.innerHTML = '<option value="">-- ALL_CLASSES --</option>';
            classes.forEach(c => {
                pFilter.innerHTML += `<option value="${c}">${c}</option>`;
                aFilter.innerHTML += `<option value="${c}">${c}</option>`;
            });
            aFilter.value = prevA;
        }

        window.handleClass = (v) => { selectedClass = v; renderView(); }

        window.updateUI = () => {
            const p = parseFloat(document.getElementById('sliderPecut').value);
            const l = parseFloat(document.getElementById('sliderLontar').value);
            document.getElementById('valPecut').innerText = p.toFixed(1);
            document.getElementById('valLontar').innerText = l.toFixed(1);
            renderWaterfill('detPecut', p, skemaPecut, 'bg-cyan-500');
            renderWaterfill('detLontar', l, skemaLontar, 'bg-cyan-500');
            const cat = getCategory(p+l);
            document.getElementById('stageStatus').innerText = cat.label;
            document.getElementById('stageStatus').style.color = cat.color;
        }

        function renderWaterfill(id, total, skema, color) {
            let rem = total;
            document.getElementById(id).innerHTML = skema.map(item => {
                const s = Math.min(rem, item.l); rem -= s;
                return `<div class="text-[9px] font-bold"><div class="flex justify-between mb-1"><span class="${item.c}">${item.n}</span><span class="text-white">${s.toFixed(1)}</span></div>
                    <div class="h-1 bg-white/5 relative overflow-hidden"><div class="${color} h-full transition-all duration-500" style="width:${(s/item.l)*100}%"></div></div></div>`;
            }).join('');
        }

        function getCategory(v) {
            if (v >= 46) return { label: 'ELITE_EXCELLENCE', color: '#10b981' };
            if (v >= 38) return { label: 'PRO_ADVANCED', color: '#3b82f6' };
            if (v >= 30) return { label: 'QUALIFIED', color: '#f59e0b' };
            if (v >= 26) return { label: 'STABLE', color: '#f97316' };
            return { label: 'LOW_RELIABILITY', color: '#ef4444' };
        }

        window.generateFinalAI = async (id) => {
            const s = students.find(x => x.id === id);
            const m = liveMarks[id] || {};
            const avgP = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0)) / 2).toFixed(2);
            const avgL = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0)) / 2).toFixed(2);
            const btn = document.querySelector(`button[data-id="${id}"]`);
            btn.innerText = "PROCESSING..."; btn.disabled = true;
            try {
                await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ type: "JANA_AI", id: id, nama: s.name, finalPecut: avgP, finalLontar: avgL }) });
                fetchMarks();
            } catch (e) { alert("CONNECTION_FAILED"); btn.disabled = false; btn.innerText = "NEURAL_LINK"; }
        }

        window.preparePrintReport = async () => {
            const adminFilter = document.getElementById('adminClassFilter').value;
            const container = document.getElementById('printReport');
            const filtered = students.filter(s => !adminFilter || s.class === adminFilter);
            let html = "";
            for (let i = 0; i < filtered.length; i += 2) {
                html += `<div class="report-card">`; 
                for (let j = i; j < i + 2 && j < filtered.length; j++) {
                    const s = filtered[j], m = liveMarks[s.id] || {};
                    const ap = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0)) / 2).toFixed(2);
                    const al = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0)) / 2).toFixed(2);
                    html += `<div class="student-row">
                        <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                            <div style="font-family:'Bebas Neue';">
                                <h3 style="margin:0; font-size:24px; text-decoration:underline;">TACTICAL_EVALUATION_HP3</h3>
                                <p style="margin:5px 0; font-size:16px; font-family:sans-serif;"><b>NAME:</b> ${s.name} | <b>CLASS:</b> ${s.class}</p>
                            </div>
                            <img src="${s.image}" class="student-img" onerror="this.src='https://via.placeholder.com/100x120?text=IMG_ERR'">
                        </div>
                        <table style="margin:30px 0;">
                            <tr style="background:#eee"><th>METRIC_ANALYSIS</th><th>P1_DATA</th><th>P2_DATA</th><th>FINAL_AVG</th></tr>
                            <tr><td>SPRINT_RUN (25%)</td><td>${m['Penilai 1']?.pecut||0}</td><td>${m['Penilai 2']?.pecut||0}</td><td><b>${ap}</b></td></tr>
                            <tr><td>SHOTPUT_THROW (25%)</td><td>${m['Penilai 1']?.lontar||0}</td><td>${m['Penilai 2']?.lontar||0}</td><td><b>${al}</b></td></tr>
                        </table>
                        <div style="padding:15px; border-left:6px solid #00f2ff; background:#f9f9f9; font-family:'JetBrains Mono'; font-size:12px;">
                            <b>NEURAL_AI_INSIGHT:</b><br><i>${m.aiReport || "ANALYSIS_PENDING_DOWNLOAD."}</i>
                        </div>
                    </div>`;
                }
                html += `</div>`; 
            }
            container.innerHTML = html;
            const images = container.getElementsByTagName('img');
            let loaded = 0;
            if (images.length === 0) { window.print(); return; }
            for (let img of images) { img.onload = img.onerror = () => { loaded++; if (loaded === images.length) { setTimeout(() => { window.print(); }, 500); } }; }
        }

        window.saveData = async () => {
            const p = parseFloat(document.getElementById('sliderPecut').value), l = parseFloat(document.getElementById('sliderLontar').value);
            const btn = document.querySelector("#scoringModal button.impact");
            btn.innerText = "UPLOADING..."; btn.disabled = true;
            try {
                await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "SAVE_MARKS", id: activeId, role: currentRole, pecut: p, lontar: l }) });
                closeModal(); fetchMarks();
            } finally { btn.disabled = false; btn.innerText = "SYNC_DATA_LIVE"; }
        }

        window.switchRole = (r) => {
            currentRole = r;
            ['roleBtn1', 'roleBtn2', 'roleBtnAdmin'].forEach(id => document.getElementById(id).className = "flex-1 py-2 text-[10px] font-bold text-cyan-500 hover:bg-cyan-500/10");
            const active = r === 'Penilai 1' ? 'roleBtn1' : r === 'Penilai 2' ? 'roleBtn2' : 'roleBtnAdmin';
            document.getElementById(active).className = "flex-1 py-2 text-[10px] font-bold bg-cyan-500 text-black";
            document.getElementById('penilaiView').classList.toggle('hidden-section', r === 'Admin');
            document.getElementById('adminView').classList.toggle('hidden-section', r !== 'Admin');
            renderView();
        }

        function renderView() { if(currentRole === 'Admin') renderAdminTable(); else renderStudentList(); }

        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody'), filter = document.getElementById('adminClassFilter').value;
            const filtered = students.filter(s => !filter || s.class === filter);
            tbody.innerHTML = filtered.map(s => {
                const m = liveMarks[s.id] || {};
                const p1 = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 1']?.lontar||0))/2).toFixed(1);
                const p2 = ((parseFloat(m['Penilai 2']?.pecut||0) + parseFloat(m['Penilai 2']?.lontar||0))/2).toFixed(1);
                const cat = getCategory(parseFloat(p1)+parseFloat(p2));
                return `<tr>
                    <td class="p-4 font-bold text-white impact italic uppercase text-lg">${s.name}</td>
                    <td class="p-4 text-cyan-400">${p1}</td>
                    <td class="p-4 text-cyan-400">${p2}</td>
                    <td class="p-4"><button data-id="${s.id}" onclick="generateFinalAI('${s.id}')" class="bg-cyan-500/10 text-cyan-400 px-3 py-1 border border-cyan-400/20 text-[9px] font-bold italic hover:bg-cyan-400 hover:text-black transition-all">NEURAL_LINK</button></td>
                    <td class="p-4 text-right font-bold text-[10px]" style="color:${cat.color}">${cat.label}</td>
                </tr>`;
            }).join('');
        }

        function renderStudentList() {
            const container = document.getElementById('studentList');
            if (!selectedClass) { container.innerHTML = '<div class="col-span-full opacity-20 p-20 text-center uppercase tracking-[1em]">NO_DATA_LINKED</div>'; return; }
            const filtered = students.filter(s => s.class === selectedClass);
            container.innerHTML = filtered.map(s => {
                const hasMark = liveMarks[s.id] && liveMarks[s.id][currentRole] && (liveMarks[s.id][currentRole].pecut > 0 || liveMarks[s.id][currentRole].lontar > 0);
                return `<div onclick="openScoring('${s.id}')" class="terminal-card p-6 cursor-pointer flex justify-between items-center group">
                    <span class="font-bold text-sm text-white group-hover:text-cyan-400 transition-colors uppercase impact italic tracking-wider">${s.name}</span>
                    <div class="h-1 w-8 ${hasMark ? 'bg-cyan-400' : 'bg-red-900'}"></div>
                </div>`;
            }).join('');
        }

        window.openScoring = (id) => { activeId = id; const s = students.find(x => x.id === id); document.getElementById('modalStudentName').innerText = s.name; const m = (liveMarks[id] && liveMarks[id][currentRole]) || { pecut: 0, lontar: 0 }; document.getElementById('sliderPecut').value = m.pecut; document.getElementById('sliderLontar').value = m.lontar; updateUI(); document.getElementById('scoringModal').classList.remove('hidden'); }
        window.closeModal = () => document.getElementById('scoringModal').classList.add('hidden');
        window.onload = fetchMarks;
    </script>
</body>
</html>
