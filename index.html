<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXON // HP3 FILTERED SYSTEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --accent: #00f2ff; --bg: #0a0c10; }
        body { background: var(--bg); color: #e2e8f0; font-family: sans-serif; }
        .glass-card { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 26px; width: 26px; border-radius: 50%; background: var(--accent); border: 3px solid white; cursor: pointer; box-shadow: 0 0 15px var(--accent); }
        .hidden-section { display: none; }
        
        @media print {
            @page { size: A4; margin: 0; }
            .no-print { display: none !important; }
            .print-only { display: block !important; color: black; background: white; padding: 0; margin: 0; }
            body { background: white !important; }
            .report-page { width: 210mm; height: 297mm; padding: 10mm; box-sizing: border-box; page-break-after: always; display: flex; flex-direction: column; justify-content: space-between; background: white; }
            .student-row { height: 135mm; border: 2px solid #000; padding: 25px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; position: relative; }
            table { width: 100%; border-collapse: collapse; border: 1.5px solid black; font-size: 14px; margin: 15px 0; }
            th, td { border: 1px solid black; padding: 10px; text-align: center; color: black !important; }
            .student-img { width: 100px; height: 130px; object-fit: cover; border: 1.5px solid #000; background: #eee; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto no-print">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6 text-center">
            <h1 class="text-3xl font-bold text-white uppercase italic tracking-tighter">SISTEM PENILAIAN AMALI <span class="text-cyan-400">// MPU3411 HP3</span></h1>
            <div class="flex gap-2 p-1 glass-card bg-white/5">
                <button onclick="switchRole('Penilai 1')" id="roleBtn1" class="px-6 py-2 rounded-xl text-xs font-bold bg-cyan-500 text-black">P1</button>
                <button onclick="switchRole('Penilai 2')" id="roleBtn2" class="px-6 py-2 rounded-xl text-xs font-bold text-white/50">P2</button>
                <button onclick="switchRole('Admin')" id="roleBtnAdmin" class="px-6 py-2 rounded-xl text-xs font-bold text-white/50">Rumusan</button>
            </div>
        </header>

        <div id="penilaiView" class="space-y-6">
            <select id="penilaiClassFilter" onchange="handleClass(this.value)" class="w-full bg-slate-900 border border-white/10 rounded-xl p-4 text-white font-bold outline-none">
                <option value="">-- Pilih Kelas (Penilai) --</option>
            </select>
            <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <div id="adminView" class="hidden-section glass-card p-6 overflow-x-auto text-white">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-xl font-bold uppercase text-cyan-400">Dashboard Rumusan</h2>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <span class="text-xs font-bold uppercase text-white/40">Tapis:</span>
                    <select id="adminClassFilter" onchange="renderAdminTable()" class="bg-slate-800 border border-white/10 rounded-lg px-4 py-2 text-xs font-bold text-white outline-none focus:border-cyan-400">
                        <option value="">-- Semua Kelas --</option>
                    </select>
                    <button id="btnPrint" onclick="preparePrintReport()" class="bg-cyan-500 px-4 py-2 rounded-lg text-xs font-bold text-black hover:bg-cyan-400 transition-all">Cetak PDF</button>
                </div>
            </div>
            <table style="border:none;" class="w-full text-left text-[11px] text-white">
                <thead class="border-b border-white/10 text-white/40 uppercase">
                    <tr><th style="border:none;">Nama Pelajar</th><th style="border:none;">P1 Avg</th><th style="border:none;">P2 Avg</th><th style="border:none;">Proses AI</th><th style="border:none;" class="text-right">Gred</th></tr>
                </thead>
                <tbody id="adminTableBody" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
    </div>

    <div id="scoringModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl hidden">
        <div class="glass-card w-full max-w-xl p-6 md:p-8 max-h-[90vh] overflow-y-auto border-white/10 relative">
            
            <button onclick="toggleRubrik()" class="absolute top-4 right-16 text-[10px] bg-amber-500/20 text-amber-400 px-3 py-1 border border-amber-500/50 hover:bg-amber-500 hover:text-black transition-all font-bold rounded italic">ðŸ“– RUBRIK_RUJUKAN</button>

            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 id="modalStudentName" class="text-2xl font-bold text-white uppercase italic">Nama Pelajar</h2>
                    <div id="liveGradeDisplay" class="text-sm font-bold uppercase mt-1 text-cyan-400 italic">Tahap: -</div>
                </div>
                <button onclick="closeModal()" class="text-white/40 text-4xl">Ã—</button>
            </div>
            <div class="space-y-8">
                <div class="bg-white/5 p-6 rounded-[20px] border border-white/10">
                    <div class="flex justify-between mb-2 uppercase text-[10px] font-bold text-white/40"><span>1. Lari Pecut (Dokumen: 25M)</span><span id="valPecut" class="text-4xl text-cyan-400 tabular-nums">0.0</span></div>
                    <input type="range" id="sliderPecut" min="0" max="25" step="0.1" value="0" oninput="updateUI()" class="w-full">
                    <div id="detPecut" class="mt-4 space-y-2 text-[8px] uppercase"></div>
                </div>
                <div class="bg-white/5 p-6 rounded-[20px] border border-white/10">
                    <div class="flex justify-between mb-2 uppercase text-[10px] font-bold text-white/40"><span>2. Lontar Peluru (Dokumen: 25M)</span><span id="valLontar" class="text-4xl text-purple-400 tabular-nums">0.0</span></div>
                    <input type="range" id="sliderLontar" min="0" max="25" step="0.1" value="0" oninput="updateUI()" class="w-full">
                    <div id="detLontar" class="mt-4 space-y-2 text-[8px] uppercase"></div>
                </div>
                <button id="btnSave" onclick="saveData()" class="w-full py-5 rounded-2xl bg-cyan-500 text-black font-bold uppercase text-xs tracking-widest active:scale-95 transition-all italic">Simpan Markah Live</button>
            </div>
        </div>
    </div>

    <div id="rubrikModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/90 hidden">
        <div class="glass-card max-w-4xl w-full p-6 border-cyan-400 bg-black overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-white mb-4 tracking-widest border-b border-cyan-900 pb-2 italic">RUJUKAN RUBRIK KEMAHIRAN (25 MARKAH)</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="text-cyan-400 font-bold mb-2 border-l-4 border-cyan-400 pl-2">LARI PECUT [cite: 3, 5, 6]</h4>
                    <div class="space-y-4 text-[10px]">
                        <div class="p-2 bg-white/5 rounded">
                            <b class="text-white block mb-1">AMAT CEMERLANG (23.0 - 25.0) </b>
                            <span>Blok tepat tanpa bantuan[cite: 3]. Punggung tinggi, bahu melepasi garisan. Tindak balas amat pantas, pecutan dikekalkan & dipping 'Torso'[cite: 5, 6].</span>
                        </div>
                        <div class="p-2 bg-white/5 rounded">
                            <b class="text-white block mb-1">CEMERLANG (19.0 - 22.9) </b>
                            <span>Blok betul[cite: 3]. Punggung tidak begitu tinggi, berat badan ke hadapan. Tindak balas pantas & teknik penamat betul[cite: 5, 6].</span>
                        </div>
                        <div class="p-2 bg-white/5 rounded">
                            <b class="text-white block mb-1">KEPUJIAN (15.0 - 18.9) </b>
                            <span>Blok hampir betul, kurang bersedia[cite: 3]. Punggung sama tinggi kepala. Tindak balas agak pantas & penamat agak betul[cite: 5, 6].</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-purple-400 font-bold mb-2 border-l-4 border-purple-400 pl-2">LONTAR PELURU </h4>
                    <div class="space-y-4 text-[10px]">
                        <div class="p-2 bg-white/5 rounded">
                            <b class="text-white block mb-1">AMAT CEMERLANG (23.0 - 25.0) </b>
                            <span>Peluru di pangkal jari, bawah telinga. Lungsuran pantas & licin. Kilasan badan serentak, lontaran kuat & ikut lajak tepat.</span>
                        </div>
                        <div class="p-2 bg-white/5 rounded">
                            <b class="text-white block mb-1">CEMERLANG (19.0 - 22.9) </b>
                            <span>Pegangan & sedia betul. Lungsuran kurang pantas. Kilasan badan serentak & lontaran serta ikut lajak betul.</span>
                        </div>
                        <div class="p-2 bg-white/5 rounded">
                            <b class="text-white block mb-1">KEPUJIAN (15.0 - 18.9) </b>
                            <span>Peluru tidak menyentuh leher. Lungsuran perlu dibaiki. Kilasan badan kurang & ikut lajak perlu dibaiki.</span>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="toggleRubrik()" class="mt-6 w-full py-2 bg-cyan-900/50 text-cyan-400 text-xs font-bold border border-cyan-500/30 rounded">TUTUP RUJUKAN</button>
        </div>
    </div>

    <div id="printReport" class="print-only"></div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzVzaPdACxnvKJDRG5cqKDZBhLu6V8z3g3N4MT55scDGIAgU-r3ekjMAt_Zj4x8O75lBg/exec";
        let students = [], liveMarks = {}, selectedClass = "", currentRole = "Penilai 1", activeId = null;

        // PEMBERATAN MARKAH BERDASARKAN DOKUMEN ANDA (JUMLAH 25 SETIAP SATU)
        const skemaPecut = [
            {n:"PERSEDIAAN & KE GARISAN (MUDAH)", l:12, c:"text-emerald-400"},
            {n:"SEDIA & MULA (SEDERHANA)", l:8, c:"text-amber-400"},
            {n:"PENAMAT (SUKAR)", l:5, c:"text-red-400"}
        ];
        const skemaLontar = [
            {n:"PEGANGAN & SEDIA (MUDAH)", l:12, c:"text-emerald-400"},
            {n:"LUNGSURAN & KILASAN (SEDERHANA)", l:8, c:"text-amber-400"},
            {n:"LONTARAN & PULIHAN (SUKAR)", l:5, c:"text-red-400"}
        ];

        async function fetchMarks() {
            try {
                const res = await fetch(scriptURL);
                const data = await res.json();
                students = data.students; liveMarks = data.marks;
                initFilters(); renderView();
            } catch (e) { console.error("Ralat API"); }
        }

        function initFilters() {
            const classes = [...new Set(students.map(s => s.class))].sort();
            const pFilter = document.getElementById('penilaiClassFilter'), aFilter = document.getElementById('adminClassFilter');
            pFilter.innerHTML = '<option value="">-- Pilih Kelas (Penilai) --</option>';
            aFilter.innerHTML = '<option value="">-- Semua Kelas --</option>';
            classes.forEach(c => { if(c){ pFilter.innerHTML += `<option value="${c}">${c}</option>`; aFilter.innerHTML += `<option value="${c}">${c}</option>`; } });
        }

        window.handleClass = (v) => { selectedClass = v; renderView(); }

        window.updateUI = () => {
            const p = parseFloat(document.getElementById('sliderPecut').value) || 0;
            const l = parseFloat(document.getElementById('sliderLontar').value) || 0;
            
            document.getElementById('valPecut').innerText = p.toFixed(1);
            document.getElementById('valLontar').innerText = l.toFixed(1);
            
            // GRED TAHAP BERDASARKAN SKALA 25 MARKAH 
            const cat = getCategory(p); // Menggunakan salah satu sebagai rujukan tahap visual
            const display = document.getElementById('liveGradeDisplay');
            display.innerText = `Tahap: ${cat.label}`;
            display.style.color = cat.color;

            renderWaterfill('detPecut', p, skemaPecut, 'bg-cyan-400');
            renderWaterfill('detLontar', l, skemaLontar, 'bg-purple-400');
        }

        function renderWaterfill(id, total, skema, color) {
            let rem = total;
            document.getElementById(id).innerHTML = skema.map(item => {
                const s = Math.min(rem, item.l); rem -= s;
                return `<div><div class="flex justify-between mb-1"><span class="${item.c}">${item.n}</span><span>${s.toFixed(1)} / ${item.l}</span></div>
                    <div class="h-1 bg-white/5 rounded-full overflow-hidden mb-2"><div class="${color} h-full transition-all duration-500" style="width:${(s/item.l)*100}%"></div></div></div>`;
            }).join('');
        }

        function getCategory(v) {
            if (v >= 23) return { label: 'Amat Cemerlang', color: '#10b981' }; // 23-25 
            if (v >= 19) return { label: 'Cemerlang', color: '#3b82f6' };     // 19-22.9 
            if (v >= 15) return { label: 'Kepujian', color: '#a855f7' };      // 15-18.9 
            if (v >= 13) return { label: 'Sederhana', color: '#f97316' };     // 13-14.9 
            return { label: 'Lemah', color: '#ef4444' };                      // < 13 
        }

        window.toggleRubrik = () => document.getElementById('rubrikModal').classList.toggle('hidden');

        window.generateFinalAI = async (id) => {
            const s = students.find(x => x.id === id), m = liveMarks[id] || {};
            const avgP = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0)) / 2).toFixed(2);
            const avgL = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0)) / 2).toFixed(2);
            const btn = document.querySelector(`button[data-id="${id}"]`); btn.innerText = "..."; btn.disabled = true;
            try {
                await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ type: "JANA_AI", id: id, nama: s.name, finalPecut: avgP, finalLontar: avgL }) });
                fetchMarks();
            } catch (e) { btn.disabled = false; btn.innerText = "âœ¨ JANA AI"; }
        }

        window.preparePrintReport = async () => {
            const btn = document.getElementById('btnPrint'), adminFilter = document.getElementById('adminClassFilter').value;
            btn.innerText = "Loading..."; btn.disabled = true;
            const container = document.getElementById('printReport'), filtered = students.filter(s => !adminFilter || s.class === adminFilter);
            let html = "";
            for (let i = 0; i < filtered.length; i += 2) {
                html += `<div class="report-page">`; 
                for (let j = i; j < i + 2 && j < filtered.length; j++) {
                    const s = filtered[j], m = liveMarks[s.id] || {}, ap = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0)) / 2).toFixed(2), al = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0)) / 2).toFixed(2);
                    html += `<div class="student-row">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div><h3 style="margin:0; font-size:20px; text-decoration:underline; font-weight:bold; color:black;">LAPORAN PENTAKSIRAN HP3</h3><p style="margin:10px 0; font-size:15px; color:black;"><b>ATLET:</b> ${s.name}<br><b>KELAS:</b> ${s.class} | <b>ID:</b> ${s.id}</p></div>
                            <img src="${s.image}" class="student-img" onerror="this.src='https://via.placeholder.com/100x130?text=Imej+Pelajar'">
                        </div>
                        <table><tr style="background:#eee"><th style="color:black;">ACARA OLAHRAGA</th><th style="color:black;">PENILAI 1</th><th style="color:black;">PENILAI 2</th><th style="color:black;">PURATA AKHIR</th></tr>
                        <tr><td style="color:black;">LARI PECUT (25%)</td><td style="color:black;">${m['Penilai 1']?.pecut||0}</td><td style="color:black;">${m['Penilai 2']?.pecut||0}</td><td style="color:black;"><b>${ap}</b></td></tr>
                        <tr><td style="color:black;">LONTAR PELURU (25%)</td><td style="color:black;">${m['Penilai 1']?.lontar||0}</td><td style="color:black;">${m['Penilai 2']?.lontar||0}</td><td style="color:black;"><b>${al}</b></td></tr></table>
                        <div style="padding:15px; border-left:6px solid #00f2ff; background:#f9f9f9; font-size:13px; color:black;"><b>RUMUSAN PRESTASI (AI):</b><br><i>${m.aiReport || "Belum dijana."}</i></div>
                    </div>`;
                }
                html += `</div>`; 
            }
            container.innerHTML = html;
            const images = container.getElementsByTagName('img'); let loaded = 0;
            const triggerPrint = () => { setTimeout(() => { window.print(); btn.innerText = "Cetak PDF"; btn.disabled = false; }, 500); };
            if (images.length === 0) { triggerPrint(); return; }
            for (let img of images) { img.onload = img.onerror = () => { loaded++; if (loaded === images.length) triggerPrint(); }; }
        }

        window.saveData = async () => {
            const p = parseFloat(document.getElementById('sliderPecut').value), l = parseFloat(document.getElementById('sliderLontar').value);
            const btn = document.getElementById('btnSave'); btn.disabled = true;
            try { await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "SAVE_MARKS", id: activeId, role: currentRole, pecut: p, lontar: l }) }); closeModal(); fetchMarks(); } finally { btn.disabled = false; }
        }

        window.switchRole = (r) => { currentRole = r; ['roleBtn1', 'roleBtn2', 'roleBtnAdmin'].forEach(id => document.getElementById(id).className = "px-6 py-2 rounded-xl text-xs font-bold transition-all text-white/50"); document.getElementById(r === 'Penilai 1' ? 'roleBtn1' : r === 'Penilai 2' ? 'roleBtn2' : 'roleBtnAdmin').className = "px-6 py-2 rounded-xl text-xs font-bold transition-all bg-cyan-500 text-black"; document.getElementById('penilaiView').classList.toggle('hidden-section', r === 'Admin'); document.getElementById('adminView').classList.toggle('hidden-section', r !== 'Admin'); renderView(); }
        function renderView() { if(currentRole === 'Admin') renderAdminTable(); else renderStudentList(); }
        function renderAdminTable() { const tbody = document.getElementById('adminTableBody'), filter = document.getElementById('adminClassFilter').value; const filtered = students.filter(s => !filter || s.class === filter); tbody.innerHTML = filtered.map(s => { const m = liveMarks[s.id] || {}, p1A = (parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 1']?.lontar||0)), p2A = (parseFloat(m['Penilai 2']?.pecut||0) + parseFloat(m['Penilai 2']?.lontar||0)), totalPurata = (p1A + p2A) / 4, cat = getCategory(totalPurata * 2); return `<tr><td style="border:none;" class="p-4 font-bold text-white uppercase italic">${s.name}</td><td style="border:none;" class="p-4 text-center text-white">${(p1A/2).toFixed(1)}</td><td style="border:none;" class="p-4 text-center text-white">${(p2A/2).toFixed(1)}</td><td style="border:none;" class="p-4 text-center"><button data-id="${s.id}" onclick="generateFinalAI('${s.id}')" class="bg-cyan-500/10 text-cyan-400 px-3 py-1 rounded-lg border border-cyan-400/20 text-[9px] font-bold italic italic">âœ¨ JANA AI</button></td><td style="border:none;" class="p-4 text-right font-bold uppercase italic" style="color:${cat.color}">${cat.label}</td></tr>`; }).join(''); }
        function renderStudentList() { const container = document.getElementById('studentList'); if (!selectedClass) { container.innerHTML = '<div class="col-span-full text-center text-white/20 p-20 uppercase font-bold tracking-widest italic">Sila Pilih Kelas Dahulu</div>'; return; } const filtered = students.filter(s => s.class === selectedClass); container.innerHTML = filtered.map(s => { const hasMark = liveMarks[s.id] && liveMarks[s.id][currentRole] && (liveMarks[s.id][currentRole].pecut > 0 || liveMarks[s.id][currentRole].lontar > 0); return `<div onclick="openScoring('${s.id}')" class="glass-card p-5 cursor-pointer hover:border-cyan-400/50 flex justify-between items-center transition-all active:scale-95"><span class="font-bold text-sm text-white uppercase italic">${s.name}</span><div class="h-2 w-2 rounded-full ${hasMark ? 'bg-emerald-500 shadow-[0_0_10px_#10b981]' : 'bg-orange-500 shadow-[0_0_10px_#f59e0b]'}"></div></div>`; }).join(''); }
        window.openScoring = (id) => { activeId = id; const s = students.find(x => x.id === id); document.getElementById('modalStudentName').innerText = s.name; const m = (liveMarks[id] && liveMarks[id][currentRole]) || { pecut: 0, lontar: 0 }; document.getElementById('sliderPecut').value = m.pecut; document.getElementById('sliderLontar').value = m.lontar; updateUI(); document.getElementById('scoringModal').classList.remove('hidden'); }
        window.closeModal = () => document.getElementById('scoringModal').classList.add('hidden');
        window.onload = fetchMarks;
    </script>
</body>
</html>
