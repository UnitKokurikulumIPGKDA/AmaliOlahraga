<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AXON // HP3 SMART INPUT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00f2ff; --bg: #05070a; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'JetBrains Mono', monospace; }
        h1, h2, h3, .impact { font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; }
        .glass-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; }
        
        /* Input Digital Stylus Friendly */
        .smart-input { 
            background: rgba(0, 242, 255, 0.05); 
            border: 2px solid var(--accent); 
            color: white; 
            font-family: 'Bebas Neue'; 
            font-size: 3rem; 
            width: 120px; 
            text-align: center;
            border-radius: 10px;
            outline: none;
        }
        .smart-input:focus { box-shadow: 0 0 20px var(--accent); background: black; }

        .hidden-section { display: none; }

        @media print {
            @page { size: A4; margin: 0; }
            .no-print { display: none !important; }
            .print-only { display: block !important; color: black !important; background: white !important; width: 210mm; }
            body { background: white !important; }
            .report-page { width: 210mm; height: 297mm; padding: 10mm; page-break-after: always; display: flex; flex-direction: column; justify-content: space-between; }
            .student-row-pdf { height: 135mm; border: 2px solid #000; padding: 20px; display: flex; flex-direction: column; justify-content: center; }
            table { width: 100%; border-collapse: collapse; border: 1.5px solid black; font-size: 13px; }
            th, td { border: 1.5px solid black; padding: 6px; text-align: center; color: black !important; }
            .student-img-pdf { width: 80px; height: 100px; object-fit: cover; border: 1px solid #000; background: #eee; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto no-print">
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6 border-b border-white/10 pb-6">
            <h1 class="text-6xl text-white italic impact">AMALI MPU3411 <span class="text-cyan-400">// HP3</span></h1>
            <div class="flex gap-2 p-1 glass-card bg-white/5 font-bold">
                <button onclick="switchRole('Penilai 1')" id="roleBtn1" class="px-6 py-2 rounded-xl text-xs bg-cyan-500 text-black font-bold">P1</button>
                <button onclick="switchRole('Penilai 2')" id="roleBtn2" class="px-6 py-2 rounded-xl text-xs text-white/50">P2</button>
                <button onclick="switchRole('Admin')" id="roleBtnAdmin" class="px-6 py-2 rounded-xl text-xs text-white/50">RUMUSAN</button>
            </div>
        </header>

        <div id="penilaiView" class="space-y-6">
            <select id="penilaiClassFilter" onchange="handleClass(this.value)" class="w-full bg-black border border-white/10 rounded-xl p-4 text-cyan-400 font-bold outline-none uppercase italic">
                <option value="">-- PILIH KELAS SEKTOR --</option>
            </select>
            <div id="studentList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <div id="adminView" class="hidden-section glass-card p-6 text-white">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-3xl impact text-cyan-400 uppercase">Dashboard Rumusan</h2>
                <div class="flex items-center gap-3 w-full md:w-auto">
                    <select id="adminClassFilter" onchange="renderAdminTable()" class="bg-black border border-white/10 rounded-lg px-4 py-2 text-xs font-bold text-white outline-none">
                        <option value="">-- SEMUA KELAS --</option>
                    </select>
                    <button id="btnPrintPDF" onclick="preparePrintReport()" class="bg-white text-black px-6 py-2 rounded-lg text-xs font-bold hover:bg-cyan-400 uppercase italic">Cetak PDF (2/Page)</button>
                </div>
            </div>
            <table class="w-full text-left text-[10px] text-white">
                <thead class="border-b border-white/10 text-white/40 font-bold italic uppercase">
                    <tr><th>Nama Pelajar</th><th class="text-center">Purata Larian</th><th class="text-center">Purata Lontaran</th><th class="text-center">AI Analysis</th><th class="text-right">Tahap</th></tr>
                </thead>
                <tbody id="adminTableBody" class="divide-y divide-white/5"></tbody>
            </table>
        </div>
    </div>

    <div id="scoringModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl hidden">
        <div class="glass-card w-full max-w-5xl p-6 md:p-8 max-h-[95vh] overflow-y-auto relative border-cyan-400/30">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-4 flex flex-col items-center border-r border-white/10 pr-6 text-center">
                    <img id="modalStudentImg" src="" class="w-full aspect-[3/4] bg-white/5 border border-white/10 rounded-lg object-cover mb-4 shadow-2xl">
                    <div id="liveGradeDisplay" class="text-xl font-bold impact italic text-cyan-400 uppercase">TAHAP: -</div>
                </div>

                <div class="md:col-span-8">
                    <div class="flex justify-between items-start mb-6 border-b border-white/10 pb-4">
                        <h2 id="modalStudentName" class="text-4xl impact text-white italic">PELAJAR</h2>
                        <button onclick="closeModal()" class="text-cyan-500 text-4xl">×</button>
                    </div>

                    <div class="space-y-12">
                        <div class="flex items-center gap-8 bg-white/5 p-6 rounded-2xl border border-cyan-400/20">
                            <div class="flex-1">
                                <h3 class="impact text-2xl text-cyan-400 mb-2 italic">01_LARI_PECUT (0-25)</h3>
                                <div id="detPecut" class="grid grid-cols-3 gap-2"></div>
                            </div>
                            <input type="number" id="numPecut" min="0" max="25" step="0.1" class="smart-input" oninput="autoAlgo()" placeholder="0.0">
                        </div>

                        <div class="flex items-center gap-8 bg-white/5 p-6 rounded-2xl border border-purple-400/20">
                            <div class="flex-1">
                                <h3 class="impact text-2xl text-purple-400 mb-2 italic">02_LONTAR_PELURU (0-25)</h3>
                                <div id="detLontar" class="grid grid-cols-4 gap-2"></div>
                            </div>
                            <input type="number" id="numLontar" min="0" max="25" step="0.1" class="smart-input" oninput="autoAlgo()" placeholder="0.0">
                        </div>

                        <button id="btnSave" onclick="saveData()" class="impact w-full py-6 rounded-2xl bg-cyan-500 text-black text-2xl hover:bg-white active:scale-95 transition-all italic uppercase font-bold">Simpan Markah Automatik</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="printReport" class="print-only"></div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzVzaPdACxnvKJDRG5cqKDZBhLu6V8z3g3N4MT55scDGIAgU-r3ekjMAt_Zj4x8O75lBg/exec";
        let students = [], liveMarks = {}, selectedClass = "", currentRole = "Penilai 1", activeId = null;

        const fasaPecut = [{n:"Persediaan", w:12/25, m:12, c:"text-emerald-400"}, {n:"Sedia/Mula", w:8/25, m:8, c:"text-amber-400"}, {n:"Penamat", w:5/25, m:5, c:"text-red-400"}];
        const fasaLontar = [{n:"Sedia", w:12/25, m:12, c:"text-emerald-400"}, {n:"Lungsur", w:8/25, m:8, c:"text-amber-400"}, {n:"Lontar", w:3/25, m:3, c:"text-blue-400"}, {n:"Pulihan", w:2/25, m:2, c:"text-red-400"}];

        async function fetchMarks() {
            try {
                const res = await fetch(scriptURL);
                const data = await res.json();
                students = data.students || []; liveMarks = data.marks || {};
                initFilters(); renderView();
            } catch (e) { alert("SILA PERIKSA URL WEB APP!"); }
        }

        function initFilters() {
            const classes = [...new Set(students.map(s => s.class))].filter(c => c).sort();
            document.getElementById('penilaiClassFilter').innerHTML = '<option value="">-- PILIH KELAS SEKTOR --</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('adminClassFilter').innerHTML = '<option value="">-- SEMUA KELAS --</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        window.handleClass = (v) => { selectedClass = v; renderStudentList(); }

        // ALGORITMA AUTOMATIK
        window.autoAlgo = () => {
            const pVal = parseFloat(document.getElementById('numPecut').value) || 0;
            const lVal = parseFloat(document.getElementById('numLontar').value) || 0;

            const render = (id, val, fasa) => {
                document.getElementById(id).innerHTML = fasa.map(f => {
                    const mark = (val * f.w).toFixed(1);
                    return `<div class="bg-white/5 p-2 rounded text-center border border-white/5"><div class="text-[7px] text-white/40 uppercase font-bold">${f.n}</div><div class="text-[10px] font-bold ${f.c}">${mark}/${f.m}</div></div>`;
                }).join('');
            };

            render('detPecut', pVal, fasaPecut); render('detLontar', lVal, fasaLontar);
            const cat = getCategory(pVal);
            document.getElementById('liveGradeDisplay').innerText = `TAHAP: ${cat.label}`;
            document.getElementById('liveGradeDisplay').style.color = cat.color;
        }

        function getCategory(v) { 
            if (v >= 23) return { label: 'AMAT CEMERLANG', color: '#10b981' }; 
            if (v >= 19) return { label: 'CEMERLANG', color: '#3b82f6' }; 
            if (v >= 15) return { label: 'KEPUJIAN', color: '#a855f7' }; 
            return { label: 'LEMAH', color: '#ef4444' }; 
        }

        window.renderStudentList = () => {
            const container = document.getElementById('studentList');
            if (!selectedClass) { container.innerHTML = '<div class="col-span-full text-center p-20 italic">Sila Pilih Kelas Dahulu</div>'; return; }
            container.innerHTML = students.filter(s => s.class === selectedClass).map(s => {
                const hasMark = liveMarks[s.id] && liveMarks[s.id][currentRole] && (liveMarks[s.id][currentRole].pecut > 0);
                return `<div onclick="openScoring('${s.id}')" class="glass-card p-6 cursor-pointer hover:border-cyan-400 transition-all flex justify-between items-center group"><span class="font-bold text-sm text-white uppercase italic">${s.name}</span><div class="h-2 w-2 rounded-full ${hasMark ? 'bg-cyan-400 shadow-[0_0_10px_#00f2ff]' : 'bg-red-900'}"></div></div>`;
            }).join('');
        }

        window.renderAdminTable = () => {
            const tbody = document.getElementById('adminTableBody'), filter = document.getElementById('adminClassFilter').value;
            const filtered = students.filter(s => !filter || s.class === filter);
            tbody.innerHTML = filtered.map(s => {
                const m = liveMarks[s.id] || {};
                const avgL = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0))/2).toFixed(1);
                const avgT = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0))/2).toFixed(1);
                return `<tr><td class="p-4 font-bold text-white italic uppercase">${s.name}</td><td class="p-4 text-center text-cyan-400">${avgL}</td><td class="p-4 text-center text-purple-400">${avgT}</td><td class="p-4 text-center"><button data-id="${s.id}" onclick="generateAI('${s.id}')" class="bg-cyan-500/10 text-cyan-400 px-3 py-1 border border-cyan-400/20 text-[9px] font-bold italic uppercase hover:bg-cyan-400 hover:text-black">✨ JANA_AI</button></td><td class="p-4 text-right font-bold italic" style="color:${getCategory(parseFloat(avgL)).color}">${getCategory(parseFloat(avgL)).label}</td></tr>`;
            }).join('');
        }

        window.generateAI = async (id) => {
            const s = students.find(x => x.id === id); const m = liveMarks[id] || {};
            const avgL = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0))/2).toFixed(1);
            const avgT = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0))/2).toFixed(1);
            const btn = document.querySelector(`button[data-id="${id}"]`); btn.innerText = "WAIT..."; btn.disabled = true;
            try { await fetch(scriptURL, { method: 'POST', body: JSON.stringify({ type: "JANA_AI", id: id, nama: s.name, finalPecut: avgL, finalLontar: avgT }) }); fetchMarks(); } catch (e) { btn.disabled = false; btn.innerText = "RETRY"; }
        }

        window.preparePrintReport = async () => {
            const btn = document.getElementById('btnPrintPDF'); btn.innerText = "LOADING PDF..."; btn.disabled = true;
            const container = document.getElementById('printReport'), filter = document.getElementById('adminClassFilter').value;
            const filtered = students.filter(s => !filter || s.class === filter);
            let html = "";
            for (let i = 0; i < filtered.length; i += 2) {
                html += `<div class="report-page">`;
                for (let j = i; j < i + 2 && j < filtered.length; j++) {
                    const s = filtered[j], m = liveMarks[s.id] || {}, ap = ((parseFloat(m['Penilai 1']?.pecut||0) + parseFloat(m['Penilai 2']?.pecut||0)) / 2).toFixed(2), al = ((parseFloat(m['Penilai 1']?.lontar||0) + parseFloat(m['Penilai 2']?.lontar||0)) / 2).toFixed(2);
                    html += `<div class="student-row-pdf"><div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><h3 style="margin:0; font-size:22px; text-decoration:underline; color:black;">LAPORAN PENTAKSIRAN HP3</h3><p style="margin:5px 0; font-size:14px; color:black;"><b>NAMA:</b> ${s.name}<br><b>KELAS:</b> ${s.class} | <b>ID:</b> ${s.id}</p></div><img src="${s.image}" class="student-img-pdf" onerror="this.src='https://via.placeholder.com/80x100?text=Imej'"></div><table style="color:black; border-color:black;"><tr style="background:#eee"><th>ACARA OLAHRAGA</th><th>PENILAI 1</th><th>PENILAI 2</th><th>PURATA AKHIR</th></tr><tr><td>LARI PECUT (25%)</td><td>${m['Penilai 1']?.pecut||0}</td><td>${m['Penilai 2']?.pecut||0}</td><td><b>${ap}</b></td></tr><tr><td>LONTAR PELURU (25%)</td><td>${m['Penilai 1']?.lontar||0}</td><td>${m['Penilai 2']?.lontar||0}</td><td><b>${al}</b></td></tr></table><div style="padding:10px; border-left:5px solid #00f2ff; background:#f4f4f4; font-size:11px; color:black;"><b>AI ANALYSIS:</b> <i>${m.aiReport || "Belum dijana."}</i></div></div>`;
                }
                html += `</div>`;
            }
            container.innerHTML = html;
            const images = Array.from(container.querySelectorAll('img'));
            await Promise.all(images.map(img => { if (img.complete) return Promise.resolve(); return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; }); }));
            setTimeout(() => { window.print(); btn.innerText = "Cetak PDF (2/Page)"; btn.disabled = false; }, 1000);
        }

        window.openScoring = (id) => { activeId = id; const s = students.find(x => x.id === id); if(!s) return; document.getElementById('modalStudentName').innerText = s.name; document.getElementById('modalStudentImg').src = s.image || ''; const m = (liveMarks[id] && liveMarks[id][currentRole]) || { pecut: 0, lontar: 0 }; document.getElementById('numPecut').value = m.pecut; document.getElementById('numLontar').value = m.lontar; autoAlgo(); document.getElementById('scoringModal').classList.remove('hidden'); }
        window.saveData = async () => { const p = parseFloat(document.getElementById('numPecut').value), l = parseFloat(document.getElementById('numLontar').value); const btn = document.getElementById('btnSave'); btn.innerText = "SAVING..."; btn.disabled = true; try { await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: "SAVE_MARKS", id: activeId, role: currentRole, pecut: p, lontar: l }) }); closeModal(); fetchMarks(); } finally { btn.disabled = false; } }
        window.closeModal = () => document.getElementById('scoringModal').classList.add('hidden');
        window.switchRole = (r) => { currentRole = r; ['roleBtn1', 'roleBtn2', 'roleBtnAdmin'].forEach(id => document.getElementById(id).className = "px-6 py-2 rounded-xl text-xs font-bold text-white/50 transition-all"); document.getElementById(r==='Penilai 1'?'roleBtn1':r==='Penilai 2'?'roleBtn2':'roleBtnAdmin').className = "px-6 py-2 rounded-xl text-xs bg-cyan-500 text-black font-bold transition-all"; renderView(); }
        function renderView() { const pV = document.getElementById('penilaiView'), aV = document.getElementById('adminView'); if(currentRole === 'Admin') { pV.classList.add('hidden-section'); aV.classList.remove('hidden-section'); renderAdminTable(); } else { pV.classList.remove('hidden-section'); aV.classList.add('hidden-section'); renderStudentList(); } }
        window.onload = fetchMarks;
    </script>
</body>
</html>
